<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å†™çœŸæ•´ç†ãƒ„ãƒ¼ãƒ« GUIç‰ˆ - Photo Organizer</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 30px;
        text-align: center;
      }

      .header h1 {
        font-size: 2.5em;
        margin-bottom: 10px;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .header p {
        font-size: 1.2em;
        opacity: 0.9;
      }

      .main-content {
        padding: 40px;
      }

      .section {
        margin-bottom: 40px;
        padding: 30px;
        border: 2px dashed #e0e0e0;
        border-radius: 10px;
        transition: all 0.3s ease;
      }

      .section:hover {
        border-color: #4facfe;
        background-color: #f8f9ff;
      }

      .section h2 {
        color: #333;
        margin-bottom: 20px;
        font-size: 1.5em;
        display: flex;
        align-items: center;
      }

      .section h2::before {
        content: "ğŸ“";
        margin-right: 10px;
        font-size: 1.2em;
      }

      .file-input-wrapper {
        position: relative;
        display: inline-block;
        width: 100%;
      }

      .file-input {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
      }

      .file-input-button {
        display: block;
        width: 100%;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        text-align: center;
        border-radius: 10px;
        font-size: 1.1em;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
      }

      .file-input-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      }

      .selected-folder {
        margin-top: 15px;
        padding: 15px;
        background: #e8f5e8;
        border-radius: 8px;
        border-left: 4px solid #4caf50;
      }

      .file-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #ddd;
        border-radius: 8px;
        margin-top: 20px;
      }

      .file-item {
        padding: 10px 15px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .file-item:last-child {
        border-bottom: none;
      }

      .file-item:nth-child(even) {
        background-color: #f9f9f9;
      }

      .file-name {
        font-weight: 500;
        color: #333;
      }

      .file-extension {
        background: #e3f2fd;
        color: #1976d2;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: bold;
      }

      .preview-section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
      }

      .preview-section h3 {
        color: #495057;
        margin-bottom: 15px;
        font-size: 1.2em;
      }

      .folder-preview {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 15px;
      }

      .folder-card {
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #4facfe;
      }

      .folder-card h4 {
        color: #333;
        margin-bottom: 8px;
        font-size: 1em;
      }

      .folder-card .file-count {
        color: #666;
        font-size: 0.9em;
      }

      .action-buttons {
        display: flex;
        gap: 15px;
        margin-top: 30px;
        justify-content: center;
      }

      .btn {
        padding: 15px 30px;
        border: none;
        border-radius: 8px;
        font-size: 1.1em;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
        text-align: center;
      }

      .btn-primary {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
      }

      .btn-secondary {
        background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        color: #333;
      }

      .btn-danger {
        background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        color: #333;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 20px;
        margin: 20px 0;
      }

      .stat-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .stat-number {
        font-size: 2em;
        font-weight: bold;
        color: #4facfe;
        margin-bottom: 5px;
      }

      .stat-label {
        color: #666;
        font-size: 0.9em;
      }

      .progress-bar {
        width: 100%;
        height: 20px;
        background: #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        margin: 20px 0;
        display: none;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        width: 0%;
        transition: width 0.3s ease;
      }

      .log-section {
        background: #2d3748;
        color: #e2e8f0;
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
        font-family: "Courier New", monospace;
        max-height: 300px;
        overflow-y: auto;
        display: none;
      }

      .log-entry {
        margin-bottom: 5px;
        padding: 5px 0;
      }

      .log-success {
        color: #68d391;
      }

      .log-error {
        color: #fc8181;
      }

      .log-info {
        color: #63b3ed;
      }

      .warning {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
        padding: 15px;
        border-radius: 8px;
        margin: 20px 0;
      }

      .warning::before {
        content: "âš ï¸ ";
        font-weight: bold;
      }

      /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
      .modal {
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
      }

      .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 0;
        border-radius: 15px;
        width: 90%;
        max-width: 600px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        animation: modalSlideIn 0.3s ease;
      }

      @keyframes modalSlideIn {
        from {
          transform: translateY(-50px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .modal-header {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        color: white;
        padding: 20px 30px;
        border-radius: 15px 15px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .modal-header h2 {
        margin: 0;
        font-size: 1.5em;
      }

      .close {
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        opacity: 0.7;
        transition: opacity 0.3s;
      }

      .close:hover {
        opacity: 1;
      }

      .modal-body {
        padding: 30px;
        line-height: 1.6;
      }

      .step {
        margin-bottom: 25px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 10px;
        border-left: 4px solid #4facfe;
      }

      .step h3 {
        color: #333;
        margin-bottom: 10px;
        font-size: 1.2em;
      }

      .execution-options {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 15px;
      }

      .option {
        background: white;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
      }

      .option h4 {
        color: #4facfe;
        margin-bottom: 8px;
        font-size: 1em;
      }

      .option code {
        background: #2d3748;
        color: #e2e8f0;
        padding: 8px 12px;
        border-radius: 5px;
        font-family: monospace;
        display: block;
        margin-top: 8px;
      }

      .modal-footer {
        padding: 20px 30px;
        text-align: center;
        border-top: 1px solid #e0e0e0;
      }

      @media (max-width: 768px) {
        .main-content {
          padding: 20px;
        }

        .action-buttons {
          flex-direction: column;
        }

        .stats {
          grid-template-columns: repeat(2, 1fr);
        }

        .modal-content {
          width: 95%;
          margin: 10% auto;
        }

        .execution-options {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ğŸ“¸ å†™çœŸæ•´ç†ãƒ„ãƒ¼ãƒ« GUIç‰ˆ</h1>
        <p>åŒã˜åå‰ã®å†™çœŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç°¡å˜ã«ãƒ•ã‚©ãƒ«ãƒ€åˆ†ã‘ã§ãã¾ã™</p>
      </div>

      <div class="main-content">
        <!-- ãƒ•ã‚©ãƒ«ãƒ€é¸æŠã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div class="section">
          <h2>ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠ</h2>
          <div class="file-input-wrapper">
            <input
              type="file"
              id="folderInput"
              class="file-input"
              webkitdirectory
              multiple
            />
            <label for="folderInput" class="file-input-button">
              ğŸ“ æ•´ç†ã—ãŸã„å†™çœŸãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„
            </label>
          </div>
          <div
            id="selectedFolder"
            class="selected-folder"
            style="display: none"
          >
            <strong>é¸æŠã•ã‚ŒãŸãƒ•ã‚©ãƒ«ãƒ€:</strong> <span id="folderPath"></span>
          </div>
        </div>

        <!-- çµ±è¨ˆæƒ…å ± -->
        <div id="statsSection" style="display: none">
          <div class="stats">
            <div class="stat-card">
              <div class="stat-number" id="totalFiles">0</div>
              <div class="stat-label">ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="totalGroups">0</div>
              <div class="stat-label">ä½œæˆäºˆå®šãƒ•ã‚©ãƒ«ãƒ€</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="duplicateFiles">0</div>
              <div class="stat-label">è¤‡æ•°äººåãƒ•ã‚¡ã‚¤ãƒ«</div>
            </div>
          </div>
        </div>

        <!-- ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ -->
        <div id="fileListSection" class="section" style="display: none">
          <h2>æ¤œå‡ºã•ã‚ŒãŸç”»åƒãƒ•ã‚¡ã‚¤ãƒ«</h2>
          <div id="fileList" class="file-list"></div>
        </div>

        <!-- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="previewSection" class="preview-section" style="display: none">
          <h3>ğŸ“‹ æ•´ç†ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h3>
          <div class="warning">
            ã“ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯å®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«ç§»å‹•ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ã™ã€‚ã€Œæ•´ç†ã‚’å®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ãƒ–ãƒ©ã‚¦ã‚¶ã®åˆ¶é™ã«ã‚ˆã‚Šå®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«ç§»å‹•ã¯ã§ãã¾ã›ã‚“ãŒã€æ•´ç†è¨ˆç”»ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚
          </div>
          <div id="folderPreview" class="folder-preview"></div>
        </div>

        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
        <div class="action-buttons">
          <button
            id="analyzeBtn"
            class="btn btn-secondary"
            onclick="analyzeFiles()"
            disabled
          >
            ğŸ” ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£æ
          </button>
          <button
            id="previewBtn"
            class="btn btn-primary"
            onclick="showPreview()"
            disabled
          >
            ğŸ‘ï¸ æ•´ç†ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
          </button>
          <button
            id="organizeBtn"
            class="btn btn-danger"
            onclick="startOrganization()"
            disabled
          >
            ğŸš€ æ•´ç†ã‚’é–‹å§‹
          </button>
          <button
            id="downloadBtn"
            class="btn btn-secondary"
            onclick="downloadOrganizationFiles()"
            disabled
          >
            ğŸ’¾ æ‰‹å‹•å®Ÿè¡Œç”¨ãƒ•ã‚¡ã‚¤ãƒ«
          </button>
        </div>

        <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
        <div id="progressBar" class="progress-bar">
          <div id="progressFill" class="progress-fill"></div>
        </div>

        <!-- ãƒ­ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
        <div id="logSection" class="log-section">
          <div id="logContent"></div>
        </div>
      </div>
    </div>

    <!-- å®Ÿè¡Œæ‰‹é †ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="executionModal" class="modal" style="display: none">
      <div class="modal-content">
        <div class="modal-header">
          <h2>ğŸš€ å†™çœŸæ•´ç†ã®å®Ÿè¡Œæ‰‹é †</h2>
          <span class="close" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body">
          <div class="step">
            <h3>ğŸ“ ã‚¹ãƒ†ãƒƒãƒ— 1: ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</h3>
            <p>ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸï¼š</p>
            <ul>
              <li>
                <strong>photo_organizer_custom.py</strong> - æ•´ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
              </li>
              <li>
                <strong>run_organizer.bat</strong> -
                å®Ÿè¡Œç”¨ãƒãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆWindowsï¼‰
              </li>
              <li><strong>organization_plan.csv</strong> - æ•´ç†è¨ˆç”»ãƒ¬ãƒãƒ¼ãƒˆ</li>
            </ul>
          </div>

          <div class="step">
            <h3>ğŸ“‚ ã‚¹ãƒ†ãƒƒãƒ— 2: ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç§»å‹•</h3>
            <p>
              ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’<strong>æ•´ç†ã—ãŸã„å†™çœŸãƒ•ã‚©ãƒ«ãƒ€</strong>ã«ç§»å‹•ã—ã¦ãã ã•ã„ã€‚
            </p>
          </div>

          <div class="step">
            <h3>â–¶ï¸ ã‚¹ãƒ†ãƒƒãƒ— 3: å®Ÿè¡Œ</h3>
            <div class="execution-options">
              <div class="option">
                <h4>ğŸ–±ï¸ ç°¡å˜å®Ÿè¡Œï¼ˆWindowsï¼‰</h4>
                <p><code>run_organizer.bat</code> ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯</p>
              </div>
              <div class="option">
                <h4>âŒ¨ï¸ ã‚³ãƒãƒ³ãƒ‰ãƒ©ã‚¤ãƒ³å®Ÿè¡Œ</h4>
                <p>å†™çœŸãƒ•ã‚©ãƒ«ãƒ€ã§ã‚³ãƒãƒ³ãƒ‰ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’é–‹ãï¼š</p>
                <code>python photo_organizer_custom.py</code>
              </div>
            </div>
          </div>

          <div class="warning">
            <strong>âš ï¸ æ³¨æ„äº‹é …</strong><br />
            â€¢ å®Ÿè¡Œå‰ã«é‡è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™<br />
            â€¢ 1ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã®ã‚°ãƒ«ãƒ¼ãƒ—ã¯æ—¢å­˜ãƒ•ã‚©ãƒ«ãƒ€ãŒã‚ã‚‹å ´åˆã®ã¿ç§»å‹•ã•ã‚Œã¾ã™<br />
            â€¢ åŒåãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹å ´åˆã¯è‡ªå‹•çš„ã«ãƒªãƒãƒ¼ãƒ ã•ã‚Œã¾ã™
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary" onclick="closeModal()">
            ç†è§£ã—ã¾ã—ãŸ
          </button>
        </div>
      </div>
    </div>

    <script>
      let selectedFiles = [];
      let organizationPlan = {};
      let existingFolders = new Set();

      // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®å‡¦ç†
      document
        .getElementById("folderInput")
        .addEventListener("change", function (event) {
          selectedFiles = Array.from(event.target.files);

          if (selectedFiles.length > 0) {
            const folderPath =
              selectedFiles[0].webkitRelativePath.split("/")[0];
            document.getElementById("folderPath").textContent = folderPath;
            document.getElementById("selectedFolder").style.display = "block";
            document.getElementById("analyzeBtn").disabled = false;

            log("ãƒ•ã‚©ãƒ«ãƒ€ãŒé¸æŠã•ã‚Œã¾ã—ãŸ: " + folderPath, "info");
          }
        });

      // ãƒ­ã‚°å‡ºåŠ›é–¢æ•°
      function log(message, type = "info") {
        const logSection = document.getElementById("logSection");
        const logContent = document.getElementById("logContent");

        logSection.style.display = "block";

        const logEntry = document.createElement("div");
        logEntry.className = `log-entry log-${type}`;
        logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;

        logContent.appendChild(logEntry);
        logContent.scrollTop = logContent.scrollHeight;
      }

      // ãƒ•ã‚¡ã‚¤ãƒ«è§£æ
      function analyzeFiles() {
        if (selectedFiles.length === 0) {
          alert("ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
          return;
        }

        log("ãƒ•ã‚¡ã‚¤ãƒ«è§£æã‚’é–‹å§‹ã—ã¾ã™...", "info");

        // ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        const imageExtensions = [
          ".jpg",
          ".jpeg",
          ".jfif",
          ".jpe", // JPEGç³»
          ".png",
          ".gif",
          ".bmp",
          ".tiff",
          ".tif", // ä¸€èˆ¬çš„ãªå½¢å¼
          ".webp",
          ".avif",
          ".heic",
          ".heif", // æ–°ã—ã„å½¢å¼
          ".raw",
          ".cr2",
          ".nef",
          ".arw",
          ".dng", // RAWå½¢å¼
          ".svg",
          ".ico", // ãã®ä»–
        ];
        const imageFiles = selectedFiles.filter((file) => {
          const extension = "." + file.name.split(".").pop().toLowerCase();
          return imageExtensions.includes(extension);
        });

        log(`${imageFiles.length} å€‹ã®ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`, "success");

        // ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’è¡¨ç¤º
        displayFileList(imageFiles);

        // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
        updateStats(imageFiles);

        // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
        document.getElementById("previewBtn").disabled = false;

        log("ãƒ•ã‚¡ã‚¤ãƒ«è§£æãŒå®Œäº†ã—ã¾ã—ãŸ", "success");
      }

      // ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§è¡¨ç¤º
      function displayFileList(files) {
        const fileList = document.getElementById("fileList");
        fileList.innerHTML = "";

        files.forEach((file) => {
          const fileItem = document.createElement("div");
          fileItem.className = "file-item";

          const fileName = document.createElement("span");
          fileName.className = "file-name";
          fileName.textContent = file.name;

          const fileExt = document.createElement("span");
          fileExt.className = "file-extension";
          fileExt.textContent = "." + file.name.split(".").pop().toUpperCase();

          fileItem.appendChild(fileName);
          fileItem.appendChild(fileExt);
          fileList.appendChild(fileItem);
        });

        document.getElementById("fileListSection").style.display = "block";
      }

      // çµ±è¨ˆæƒ…å ±æ›´æ–°
      function updateStats(files) {
        const groups = analyzeFileGroups(files);
        const duplicateCount = countDuplicateNameFiles(files, groups);

        document.getElementById("totalFiles").textContent = files.length;
        document.getElementById("totalGroups").textContent =
          Object.keys(groups).length;
        document.getElementById("duplicateFiles").textContent = duplicateCount;
        document.getElementById("statsSection").style.display = "block";
      }

      // ãƒ•ã‚¡ã‚¤ãƒ«ã‚°ãƒ«ãƒ¼ãƒ—è§£æï¼ˆ1ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚°ãƒ«ãƒ¼ãƒ—ã¯é™¤å¤–ï¼‰
      function analyzeFileGroups(files) {
        const groups = {};

        files.forEach((file) => {
          const fileName = file.name.replace(/\.[^/.]+$/, ""); // æ‹¡å¼µå­ã‚’é™¤å»

          // ç‰¹æ®Šãƒ‘ã‚¿ãƒ¼ãƒ³ã®é™¤å»
          let cleanName = fileName.replace(/\s*-?\s*ã‚³ãƒ”ãƒ¼$/, "");
          cleanName = cleanName.replace(/\s*ã‚³ãƒ”ãƒ¼$/, "");
          cleanName = cleanName.replace(
            /photo-\d+\s*\(\d+\)\s*-?\s*ã‚³ãƒ”ãƒ¼$/,
            ""
          );

          // "åå‰ (æ•°å­—)" ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å‡¦ç†
          const match = cleanName.match(/^(.+?)\s*\((\d+)\)$/);
          const baseName = match ? match[1].trim() : cleanName.trim();

          if (!groups[baseName]) {
            groups[baseName] = [];
          }
          groups[baseName].push(file);
        });

        // 1ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚°ãƒ«ãƒ¼ãƒ—ã‚’é™¤å¤–
        const filteredGroups = {};
        Object.keys(groups).forEach((baseName) => {
          if (groups[baseName].length > 1) {
            filteredGroups[baseName] = groups[baseName];
          }
        });

        organizationPlan = filteredGroups;
        return filteredGroups;
      }

      // è¤‡æ•°äººåãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚«ã‚¦ãƒ³ãƒˆ
      function countDuplicateNameFiles(files, groups) {
        // ã“ã®å®Ÿè£…ã§ã¯ç°¡å˜ãªä¾‹ã¨ã—ã¦ã€æ—¢å­˜ãƒ•ã‚©ãƒ«ãƒ€åã§å§‹ã¾ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        // å®Ÿéš›ã®å®Ÿè£…ã§ã¯ã€ã‚ˆã‚Šè¤‡é›‘ãªãƒ­ã‚¸ãƒƒã‚¯ãŒå¿…è¦
        return 0; // ç°¡ç•¥åŒ–
      }

      // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
      function showPreview() {
        if (Object.keys(organizationPlan).length === 0) {
          alert("ã¾ãšãƒ•ã‚¡ã‚¤ãƒ«ã‚’è§£æã—ã¦ãã ã•ã„ã€‚");
          return;
        }

        log("æ•´ç†ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆä¸­...", "info");

        const folderPreview = document.getElementById("folderPreview");
        folderPreview.innerHTML = "";

        // ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®æƒ…å ±ã‚’è¡¨ç¤º
        const allGroups = {};
        selectedFiles.forEach((file) => {
          const fileName = file.name.replace(/\.[^/.]+$/, "");
          let cleanName = fileName.replace(/\s*-?\s*ã‚³ãƒ”ãƒ¼$/, "");
          cleanName = cleanName.replace(/\s*ã‚³ãƒ”ãƒ¼$/, "");
          const match = cleanName.match(/^(.+?)\s*\((\d+)\)$/);
          const baseName = match ? match[1].trim() : cleanName.trim();

          if (!allGroups[baseName]) {
            allGroups[baseName] = [];
          }
          allGroups[baseName].push(file);
        });

        const skippedGroups = Object.keys(allGroups).filter(
          (name) => allGroups[name].length === 1 && !organizationPlan[name]
        );

        if (skippedGroups.length > 0) {
          const skipInfo = document.createElement("div");
          skipInfo.className = "warning";
          skipInfo.style.marginBottom = "20px";
          skipInfo.innerHTML = `
            <strong>ğŸ“ ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã‚‹ãƒ•ã‚¡ã‚¤ãƒ«:</strong><br>
            ${
              skippedGroups.length
            }å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯1å€‹ã®ã¿ã®ãŸã‚ã€ãƒ•ã‚©ãƒ«ãƒ€ã«ç§»å‹•ã•ã‚Œã¾ã›ã‚“ã€‚<br>
            <small style="color: #666;">ä¾‹: ${skippedGroups
              .slice(0, 3)
              .join(", ")}${skippedGroups.length > 3 ? "..." : ""}</small>
          `;
          folderPreview.appendChild(skipInfo);
        }

        Object.entries(organizationPlan).forEach(([folderName, files]) => {
          const folderCard = document.createElement("div");
          folderCard.className = "folder-card";

          const folderTitle = document.createElement("h4");
          folderTitle.textContent = `ğŸ“ ${folderName}`;

          const fileCount = document.createElement("div");
          fileCount.className = "file-count";
          fileCount.textContent = `${files.length} ãƒ•ã‚¡ã‚¤ãƒ«`;

          folderCard.appendChild(folderTitle);
          folderCard.appendChild(fileCount);

          // ãƒ•ã‚¡ã‚¤ãƒ«åã®ä¸€éƒ¨ã‚’è¡¨ç¤º
          if (files.length > 0) {
            const fileNames = files
              .slice(0, 3)
              .map((f) => f.name)
              .join(", ");
            const fileList = document.createElement("div");
            fileList.style.fontSize = "0.8em";
            fileList.style.color = "#888";
            fileList.style.marginTop = "5px";
            fileList.textContent = fileNames + (files.length > 3 ? "..." : "");
            folderCard.appendChild(fileList);
          }

          folderPreview.appendChild(folderCard);
        });

        document.getElementById("previewSection").style.display = "block";
        document.getElementById("organizeBtn").disabled = false;
        document.getElementById("downloadBtn").disabled = false;

        log(
          `ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸï¼ˆ${
            Object.keys(organizationPlan).length
          }å€‹ã®ãƒ•ã‚©ãƒ«ãƒ€ã€${skippedGroups.length}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰`,
          "success"
        );
      }

      // æ•´ç†é–‹å§‹ï¼ˆç›´æ¥å®Ÿè¡Œç‰ˆï¼‰
      async function startOrganization() {
        if (Object.keys(organizationPlan).length === 0) {
          alert("æ•´ç†è¨ˆç”»ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
          return;
        }

        // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
        if (
          !confirm(
            "å†™çœŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿéš›ã«ç§»å‹•ã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\nâ€»å®Ÿè¡Œå‰ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚"
          )
        ) {
          return;
        }

        log("å†™çœŸæ•´ç†ã‚’é–‹å§‹ã—ã¾ã™...", "info");

        try {
          // ãƒ­ãƒ¼ã‚«ãƒ«Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
          const response = await fetch("/execute-organizer", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              organizationPlan: organizationPlan,
              folderPath: selectedFiles[0].webkitRelativePath.split("/")[0],
            }),
          });

          if (response.ok) {
            const result = await response.json();
            log(
              `æ•´ç†å®Œäº†: ${result.moved_files}ãƒ•ã‚¡ã‚¤ãƒ«ç§»å‹•ã€${result.created_folders}ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆ`,
              "success"
            );

            if (result.errors && result.errors.length > 0) {
              result.errors.forEach((error) =>
                log(`ã‚¨ãƒ©ãƒ¼: ${error}`, "error")
              );
            }
          } else {
            throw new Error("ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
          }
        } catch (error) {
          log(`ã‚¨ãƒ©ãƒ¼: ${error.message}`, "error");
          log("ä»£æ›¿æ¡ˆ: æ•´ç†è¨ˆç”»ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦æ‰‹å‹•å®Ÿè¡Œã—ã¦ãã ã•ã„", "info");

          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          const pythonScript = generateCustomPythonScript();
          downloadFile(pythonScript, "photo_organizer_custom.py", "text/plain");

          const batchScript = generateBatchScript();
          downloadFile(batchScript, "run_organizer.bat", "text/plain");
        }
      }

      // ä»£æ›¿å®Ÿè¡Œæ–¹æ³•ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆï¼‰
      function downloadOrganizationFiles() {
        if (Object.keys(organizationPlan).length === 0) {
          alert("æ•´ç†è¨ˆç”»ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
          return;
        }

        log("æ•´ç†ç”¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆä¸­...", "info");

        // 1. ã‚«ã‚¹ã‚¿ãƒ Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç”Ÿæˆãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        const pythonScript = generateCustomPythonScript();
        downloadFile(pythonScript, "photo_organizer_custom.py", "text/plain");

        // 2. ãƒãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆWindowsç”¨ï¼‰
        const batchScript = generateBatchScript();
        downloadFile(batchScript, "run_organizer.bat", "text/plain");

        // 3. CSVãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        const csvReport = generateCSVReport();
        downloadFile(csvReport, "organization_plan.csv", "text/csv");

        // 4. å®Ÿè¡Œæ‰‹é †ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        document.getElementById("executionModal").style.display = "block";

        log("æ•´ç†ç”¨ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸ", "success");
      }

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
      function closeModal() {
        document.getElementById("executionModal").style.display = "none";
      }

      // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
      function downloadFile(content, filename, mimeType) {
        const blob = new Blob([content], { type: mimeType });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }

      // æ•´ç†è¨ˆç”»ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      function downloadOrganizationPlan() {
        if (Object.keys(organizationPlan).length === 0) {
          alert("æ•´ç†è¨ˆç”»ãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
          return;
        }

        log("æ•´ç†è¨ˆç”»ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...", "info");

        // Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç”Ÿæˆ
        const pythonScript = generatePythonScript();

        // ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        const blob = new Blob([pythonScript], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "photo_organizer_plan.py";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        // CSVãƒ¬ãƒãƒ¼ãƒˆã‚‚ç”Ÿæˆ
        const csvReport = generateCSVReport();
        const csvBlob = new Blob([csvReport], { type: "text/csv" });
        const csvUrl = URL.createObjectURL(csvBlob);
        const csvA = document.createElement("a");
        csvA.href = csvUrl;
        csvA.download = "organization_plan.csv";
        document.body.appendChild(csvA);
        csvA.click();
        document.body.removeChild(csvA);
        URL.revokeObjectURL(csvUrl);

        log("æ•´ç†è¨ˆç”»ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸ", "success");
      }

      // ã‚«ã‚¹ã‚¿ãƒ Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆç”Ÿæˆï¼ˆ1ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚‚æ—¢å­˜ãƒ•ã‚©ãƒ«ãƒ€ãŒã‚ã‚Œã°ç§»å‹•ï¼‰
      function generateCustomPythonScript() {
        let script = `#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
å†™çœŸæ•´ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆ - GUIç‰ˆã§ç”Ÿæˆï¼ˆã‚«ã‚¹ã‚¿ãƒ ç‰ˆï¼‰
ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯å†™çœŸæ•´ç†ãƒ„ãƒ¼ãƒ«GUIç‰ˆã§ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚

ç‰¹å¾´:
- 2å€‹ä»¥ä¸Šã®åŒåãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å‡¦ç†
- 1å€‹ã®ã¿ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚‚æ—¢å­˜ãƒ•ã‚©ãƒ«ãƒ€ã¨åŒåãªã‚‰ç§»å‹•
- è¤‡æ•°äººåãƒ•ã‚¡ã‚¤ãƒ«ã®è‡ªå‹•çµ±åˆ
"""

import os
import shutil
import re
from pathlib import Path

def get_unique_filename(folder_path, filename):
    """é‡è¤‡ã—ãªã„ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ"""
    destination_path = folder_path / filename
    
    if not destination_path.exists():
        return destination_path
    
    base_name = destination_path.stem
    extension = destination_path.suffix
    
    # è¤‡é›‘ãªç•ªå·ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ã™ã¹ã¦é™¤å»
    clean_base_name = re.sub(r'\\s*\\(\\d+\\)(?:\\s*\\(\\d+\\))*\\s*$', '', base_name).strip()
    
    # ãƒ•ã‚©ãƒ«ãƒ€å†…ã®æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰æœ€å¤§ç•ªå·ã‚’è¦‹ã¤ã‘ã‚‹
    max_number = 0
    if folder_path.exists():
        try:
            for existing_file in folder_path.iterdir():
                if existing_file.is_file() and existing_file.suffix.lower() == extension.lower():
                    existing_base = existing_file.stem
                    if existing_base.startswith(clean_base_name):
                        remaining = existing_base[len(clean_base_name):].strip()
                        if remaining == '':
                            max_number = max(max_number, 1)
                        else:
                            numbers = re.findall(r'\\((\\d+)\\)', remaining)
                            if numbers:
                                last_number = int(numbers[-1])
                                max_number = max(max_number, last_number)
        except Exception:
            max_number = 1
    
    counter = max_number + 1
    new_filename = f"{clean_base_name} ({counter}){extension}"
    new_destination_path = folder_path / new_filename
    
    while new_destination_path.exists() and counter <= 1000:
        counter += 1
        new_filename = f"{clean_base_name} ({counter}){extension}"
        new_destination_path = folder_path / new_filename
    
    if counter > 1000:
        import time
        timestamp = int(time.time())
        new_filename = f"{clean_base_name}_{timestamp}{extension}"
        new_destination_path = folder_path / new_filename
    
    return new_destination_path

def organize_photos():
    """å†™çœŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ•´ç†ã™ã‚‹"""
    current_dir = Path('.')
    
    # ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã®æ‹¡å¼µå­
    image_extensions = {
        '.jpg', '.jpeg', '.jfif', '.jpe',
        '.png', '.gif', '.bmp', '.tiff', '.tif',
        '.webp', '.avif', '.heic', '.heif',
        '.raw', '.cr2', '.nef', '.arw', '.dng',
        '.svg', '.ico'
    }
    
    # æ—¢å­˜ãƒ•ã‚©ãƒ«ãƒ€ã‚’æ¤œå‡º
    existing_folders = set()
    for item in current_dir.iterdir():
        if item.is_dir() and not item.name.startswith('.') and item.name != '__pycache__':
            existing_folders.add(item.name)
    
    print(f"æ—¢å­˜ãƒ•ã‚©ãƒ«ãƒ€æ•°: {len(existing_folders)}")
    if existing_folders:
        print(f"æ—¢å­˜ãƒ•ã‚©ãƒ«ãƒ€ã®ä¾‹: {list(sorted(existing_folders))[:5]}")
    
    # ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
    image_files = []
    for file_path in current_dir.iterdir():
        if file_path.is_file() and file_path.suffix.lower() in image_extensions:
            image_files.append(file_path)
    
    print(f"è¦‹ã¤ã‹ã£ãŸç”»åƒãƒ•ã‚¡ã‚¤ãƒ«æ•°: {len(image_files)}")
    
    if len(image_files) == 0:
        print("æ•´ç†å¯¾è±¡ã®ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚")
        return False
    
    # ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è§£æã—ã¦ãƒ™ãƒ¼ã‚¹åã‚’æŠ½å‡º
    base_names = {}
    for file_path in image_files:
        file_name = file_path.stem
        
        # ç‰¹æ®Šãƒ‘ã‚¿ãƒ¼ãƒ³ã®é™¤å»
        clean_name = re.sub(r'\\s*-\\s*ã‚³ãƒ”ãƒ¼$', '', file_name)
        clean_name = re.sub(r'\\s*ã‚³ãƒ”ãƒ¼$', '', clean_name)
        clean_name = re.sub(r'photo-\\d+\\s*\\(\\d+\\)\\s*-\\s*ã‚³ãƒ”ãƒ¼$', '', clean_name)
        
        # "åå‰ (æ•°å­—)" ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å‡¦ç†
        match = re.match(r'^(.+?)\\s*\\((\\d+)\\)$', clean_name)
        base_name = match.group(1).strip() if match else clean_name.strip()
        
        # è¤‡æ•°äººåã®å‡¦ç†: æ—¢å­˜ãƒ•ã‚©ãƒ«ãƒ€åã§å§‹ã¾ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        target_folder = None
        for folder_name in sorted(existing_folders, key=len, reverse=True):
            if base_name.startswith(folder_name) and len(base_name) > len(folder_name):
                target_folder = folder_name
                print(f"è¤‡æ•°äººåæ¤œå‡º: '{base_name}' â†’ '{target_folder}' ãƒ•ã‚©ãƒ«ãƒ€ã«ç§»å‹•äºˆå®š")
                break
        
        final_base_name = target_folder if target_folder else base_name
        
        if final_base_name not in base_names:
            base_names[final_base_name] = []
        base_names[final_base_name].append(file_path)
    
    # å‡¦ç†å¯¾è±¡ã‚°ãƒ«ãƒ¼ãƒ—ã‚’æ±ºå®š
    groups_to_process = {}
    for base_name, files in base_names.items():
        if len(files) > 1:
            # è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã¯å¸¸ã«å‡¦ç†å¯¾è±¡
            groups_to_process[base_name] = files
            print(f"'{base_name}' ãƒ•ã‚©ãƒ«ãƒ€: {len(files)}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«")
        elif len(files) == 1:
            # 1ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚‚æ—¢å­˜ãƒ•ã‚©ãƒ«ãƒ€ã¨åŒã˜åå‰ãªã‚‰å‡¦ç†å¯¾è±¡
            if base_name in existing_folders:
                groups_to_process[base_name] = files
                print(f"'{base_name}' ãƒ•ã‚©ãƒ«ãƒ€: {len(files)}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆæ—¢å­˜ãƒ•ã‚©ãƒ«ãƒ€ã«ç§»å‹•ï¼‰")
            else:
                print(f"'{base_name}': 1å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ï¼ˆã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ï¼‰")
    
    if len(groups_to_process) == 0:
        print("\\næ•´ç†å¯¾è±¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚°ãƒ«ãƒ¼ãƒ—ãŒã‚ã‚Šã¾ã›ã‚“ã€‚")
        return False
    
    total_files = sum(len(files) for files in groups_to_process.values())
    print(f"\\nåˆè¨ˆ {total_files} å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ {len(groups_to_process)} å€‹ã®ãƒ•ã‚©ãƒ«ãƒ€ã«æ•´ç†ã—ã¾ã™ã€‚")
    
    # å®Ÿè¡Œç¢ºèª
    response = input("\\nå®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ (y/n): ")
    if response.lower() not in ['y', 'yes', 'ã¯ã„']:
        print("ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚")
        return False
    
    # ãƒ•ã‚¡ã‚¤ãƒ«ç§»å‹•å‡¦ç†
    moved_count = 0
    error_count = 0
    
    for base_name, files in groups_to_process.items():
        print(f"\\n'{base_name}' ã‚°ãƒ«ãƒ¼ãƒ—ã‚’å‡¦ç†ä¸­...")
        
        # ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆ
        folder_path = current_dir / base_name
        folder_path.mkdir(exist_ok=True)
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç§»å‹•
        for file_path in files:
            try:
                destination = get_unique_filename(folder_path, file_path.name)
                shutil.move(str(file_path), str(destination))
                
                if destination.name != file_path.name:
                    print(f"  åå‰å¤‰æ›´: {file_path.name} â†’ {destination.name}")
                else:
                    print(f"  ç§»å‹•: {file_path.name} â†’ {base_name}/")
                moved_count += 1
            except Exception as e:
                print(f"  ã‚¨ãƒ©ãƒ¼: {file_path.name} ã®ç§»å‹•ã«å¤±æ•— - {e}")
                error_count += 1
    
    print(f"\\n=== æ•´ç†å®Œäº† ===")
    print(f"ç§»å‹•æˆåŠŸ: {moved_count} ãƒ•ã‚¡ã‚¤ãƒ«")
    if error_count > 0:
        print(f"ç§»å‹•å¤±æ•—: {error_count} ãƒ•ã‚¡ã‚¤ãƒ«")
    
    return True

if __name__ == "__main__":
    print("=" * 50)
    print("å†™çœŸæ•´ç†ãƒ„ãƒ¼ãƒ« - ã‚«ã‚¹ã‚¿ãƒ ç‰ˆ")
    print("=" * 50)
    
    try:
        success = organize_photos()
        if success:
            print("\\næ•´ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼")
        else:
            print("\\næ•´ç†ã‚’ä¸­æ­¢ã—ã¾ã—ãŸã€‚")
    except KeyboardInterrupt:
        print("\\n\\nãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã£ã¦ä¸­æ–­ã•ã‚Œã¾ã—ãŸã€‚")
    except Exception as e:
        print(f"\\näºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
    
    input("\\nEnterã‚­ãƒ¼ã‚’æŠ¼ã—ã¦çµ‚äº†...")
`;

        return script;
      }

      // ãƒãƒƒãƒãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆï¼ˆWindowsç”¨ï¼‰
      function generateBatchScript() {
        return `@echo off
chcp 65001 > nul
echo ==========================================
echo å†™çœŸæ•´ç†ãƒ„ãƒ¼ãƒ« - è‡ªå‹•å®Ÿè¡Œ
echo ==========================================
echo.

REM PythonãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
python --version > nul 2>&1
if errorlevel 1 (
    echo ã‚¨ãƒ©ãƒ¼: PythonãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
    echo https://www.python.org/ ã‹ã‚‰Pythonã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚
    echo.
    pause
    exit /b 1
)

echo PythonãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚
echo å†™çœŸæ•´ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™...
echo.

REM ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
python photo_organizer_custom.py

echo.
echo å®Ÿè¡ŒãŒå®Œäº†ã—ã¾ã—ãŸã€‚
pause
`;
      }

      // Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆç”Ÿæˆï¼ˆå¾“æ¥ç‰ˆï¼‰
      function generatePythonScript() {
        let script = `#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
å†™çœŸæ•´ç†ã‚¹ã‚¯ãƒªãƒ—ãƒˆ - GUIç‰ˆã§ç”Ÿæˆ
ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯å†™çœŸæ•´ç†ãƒ„ãƒ¼ãƒ«GUIç‰ˆã§ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚

æ³¨æ„: ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯2å€‹ä»¥ä¸Šã®åŒåãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‹ã‚°ãƒ«ãƒ¼ãƒ—ã®ã¿ã‚’å‡¦ç†ã—ã¾ã™ã€‚
1å€‹ã®ã¿ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ãã®ã¾ã¾æ®‹ã•ã‚Œã¾ã™ã€‚
"""

import os
import shutil
from pathlib import Path

def organize_photos():
    """å†™çœŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ•´ç†ã™ã‚‹ï¼ˆ1ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚°ãƒ«ãƒ¼ãƒ—ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰"""
    current_dir = Path('.')
    
    print("å†™çœŸæ•´ç†ã‚’é–‹å§‹ã—ã¾ã™...")
    print("æ³¨æ„: 1å€‹ã®ã¿ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒ•ã‚©ãƒ«ãƒ€ã«ç§»å‹•ã•ã‚Œã¾ã›ã‚“ã€‚")
    
    # æ•´ç†è¨ˆç”»
    organization_plan = {
`;

        Object.entries(organizationPlan).forEach(([folderName, files]) => {
          script += `        "${folderName}": [\n`;
          files.forEach((file) => {
            script += `            "${file.name}",\n`;
          });
          script += `        ],\n`;
        });

        script += `    }
    
    print("å†™çœŸæ•´ç†ã‚’é–‹å§‹ã—ã¾ã™...")
    
    for folder_name, file_names in organization_plan.items():
        print(f"\\n'{folder_name}' ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆä¸­...")
        folder_path = current_dir / folder_name
        folder_path.mkdir(exist_ok=True)
        
        for file_name in file_names:
            source_file = current_dir / file_name
            if source_file.exists():
                destination = folder_path / file_name
                try:
                    shutil.move(str(source_file), str(destination))
                    print(f"  ç§»å‹•: {file_name} â†’ {folder_name}/")
                except Exception as e:
                    print(f"  ã‚¨ãƒ©ãƒ¼: {file_name} ã®ç§»å‹•ã«å¤±æ•— - {e}")
            else:
                print(f"  è­¦å‘Š: {file_name} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“")
    
    print("\\næ•´ç†å®Œäº†ï¼")

if __name__ == "__main__":
    response = input("å†™çœŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ•´ç†ã—ã¾ã™ã‹ï¼Ÿ (y/n): ")
    if response.lower() in ['y', 'yes', 'ã¯ã„']:
        organize_photos()
    else:
        print("ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚")
`;

        return script;
      }

      // CSVãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
      function generateCSVReport() {
        let csv = "ãƒ•ã‚©ãƒ«ãƒ€å,ãƒ•ã‚¡ã‚¤ãƒ«æ•°,ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§\\n";

        Object.entries(organizationPlan).forEach(([folderName, files]) => {
          const fileNames = files.map((f) => f.name).join("; ");
          csv += `"${folderName}",${files.length},"${fileNames}"\\n`;
        });

        return csv;
      }

      // åˆæœŸåŒ–
      document.addEventListener("DOMContentLoaded", function () {
        log("å†™çœŸæ•´ç†ãƒ„ãƒ¼ãƒ« GUIç‰ˆãŒèµ·å‹•ã—ã¾ã—ãŸ", "info");
        log("ãƒ•ã‚©ãƒ«ãƒ€ã‚’é¸æŠã—ã¦é–‹å§‹ã—ã¦ãã ã•ã„", "info");

        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        window.addEventListener("click", function (event) {
          const modal = document.getElementById("executionModal");
          if (event.target === modal) {
            closeModal();
          }
        });
      });
    </script>
  </body>
</html>
